/*
 * Copyright (C) 2023 mibi88
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 */
#version 400 core

#define RADIUS 10
#define KERNEL_W int(RADIUS*2+1)
#define KERNEL_H KERNEL_W
#define OFFSET 1/800
#define KERNEL_SUM 0.9991245656040866
#define MIN_COLOR 0.7

in vec2 pass_texture_coords;

out vec4 out_color;

uniform sampler2D texture_sampler;

uniform vec2 tex_size;

void main(void) {
    float kernel[KERNEL_W*KERNEL_H] = float[](
        0.017683882565766154, 0.01672823616012176, 0.01672823616012176, 
        0.014160146199197409, 0.014160146199197409, 0.010725816958894883, 
        0.010725816958894883, 0.007270061466672242, 0.007270061466672242, 
        0.004409515177532111, 0.004409515177532111, 0.0023932532557609594, 
        0.0023932532557609594, 0.001162335581275325, 0.001162335581275325, 
        0.0005051489613062897, 0.0005051489613062897, 0.00019645019020577968, 
        0.00019645019020577968, 6.836447775506744e-05, 6.836447775506744e-05, 
        0.01672823616012176, 0.01582423339377573, 0.01582423339377573, 
        0.013394924378234935, 0.013394924378234935, 0.010146188114027382, 
        0.010146188114027382, 0.006877183483932815, 0.006877183483932815, 
        0.004171222635474598, 0.004171222635474598, 0.0022639205787790247, 
        0.0022639205787790247, 0.001099522349154643, 0.001099522349154643, 
        0.00047785044315610213, 0.00047785044315610213, 0.0001858339175936924, 
        0.0001858339175936924, 6.467002506927198e-05, 6.467002506927198e-05, 
        0.01672823616012176, 0.01582423339377573, 0.01582423339377573, 
        0.013394924378234935, 0.013394924378234935, 0.010146188114027382, 
        0.010146188114027382, 0.006877183483932815, 0.006877183483932815, 
        0.004171222635474598, 0.004171222635474598, 0.0022639205787790247, 
        0.0022639205787790247, 0.001099522349154643, 0.001099522349154643, 
        0.00047785044315610213, 0.00047785044315610213, 0.0001858339175936924, 
        0.0001858339175936924, 6.467002506927198e-05, 6.467002506927198e-05, 
        0.014160146199197409, 0.013394924378234935, 0.013394924378234935, 
        0.011338558692467644, 0.011338558692467644, 0.008588562815826544, 
        0.008588562815826544, 0.005821410137868691, 0.005821410137868691, 
        0.0035308637313793104, 0.0035308637313793104, 0.001916367396540226, 
        0.001916367396540226, 0.0009307255746682022, 0.0009307255746682022, 
        0.0004044916673625216, 0.0004044916673625216, 0.00015730501510788898, 
        0.00015730501510788898, 5.474199436935659e-05, 5.474199436935659e-05, 
        0.014160146199197409, 0.013394924378234935, 0.013394924378234935, 
        0.011338558692467644, 0.011338558692467644, 0.008588562815826544, 
        0.008588562815826544, 0.005821410137868691, 0.005821410137868691, 
        0.0035308637313793104, 0.0035308637313793104, 0.001916367396540226, 
        0.001916367396540226, 0.0009307255746682022, 0.0009307255746682022, 
        0.0004044916673625216, 0.0004044916673625216, 0.00015730501510788898, 
        0.00015730501510788898, 5.474199436935659e-05, 5.474199436935659e-05, 
        0.010725816958894883, 0.010146188114027382, 0.010146188114027382, 
        0.008588562815826544, 0.008588562815826544, 0.006505536836035465, 
        0.006505536836035465, 0.004409515177532111, 0.004409515177532111, 
        0.0026745061496414213, 0.0026745061496414213, 0.0014515814760761026, 
        0.0014515814760761026, 0.0007049921669183901, 0.0007049921669183901, 
        0.00030638833275425546, 0.00030638833275425546, 
        0.00011915306346618386, 0.00011915306346618386, 
        4.1465151793690705e-05, 4.1465151793690705e-05, 0.010725816958894883, 
        0.010146188114027382, 0.010146188114027382, 0.008588562815826544, 
        0.008588562815826544, 0.006505536836035465, 0.006505536836035465, 
        0.004409515177532111, 0.004409515177532111, 0.0026745061496414213, 
        0.0026745061496414213, 0.0014515814760761026, 0.0014515814760761026, 
        0.0007049921669183901, 0.0007049921669183901, 0.00030638833275425546, 
        0.00030638833275425546, 0.00011915306346618386, 
        0.00011915306346618386, 4.1465151793690705e-05, 
        4.1465151793690705e-05, 0.007270061466672242, 0.006877183483932815, 
        0.006877183483932815, 0.005821410137868691, 0.005821410137868691, 
        0.004409515177532111, 0.004409515177532111, 0.0029888116216916683, 
        0.0029888116216916683, 0.0018128058846614335, 0.0018128058846614335, 
        0.0009838958277396718, 0.0009838958277396718, 0.00047785044315610197, 
        0.00047785044315610197, 0.0002076729465299554, 0.0002076729465299554, 
        8.076308766607072e-05, 8.076308766607072e-05, 2.810547703921344e-05, 
        2.810547703921344e-05, 0.007270061466672242, 0.006877183483932815, 
        0.006877183483932815, 0.005821410137868691, 0.005821410137868691, 
        0.004409515177532111, 0.004409515177532111, 0.0029888116216916683, 
        0.0029888116216916683, 0.0018128058846614335, 0.0018128058846614335, 
        0.0009838958277396718, 0.0009838958277396718, 0.00047785044315610197, 
        0.00047785044315610197, 0.0002076729465299554, 0.0002076729465299554, 
        8.076308766607072e-05, 8.076308766607072e-05, 2.810547703921344e-05, 
        2.810547703921344e-05, 0.004409515177532111, 0.004171222635474598, 
        0.004171222635474598, 0.0035308637313793104, 0.0035308637313793104, 
        0.0026745061496414213, 0.0026745061496414213, 0.0018128058846614335, 
        0.0018128058846614335, 0.0010995223491546435, 0.0010995223491546435, 
        0.0005967629854874508, 0.0005967629854874508, 0.00028983094453144485, 
        0.00028983094453144485, 0.00012596000926328032, 
        0.00012596000926328032, 4.898528884253113e-05, 4.898528884253113e-05, 
        1.70468335301324e-05, 1.70468335301324e-05, 0.004409515177532111, 
        0.004171222635474598, 0.004171222635474598, 0.0035308637313793104, 
        0.0035308637313793104, 0.0026745061496414213, 0.0026745061496414213, 
        0.0018128058846614335, 0.0018128058846614335, 0.0010995223491546435, 
        0.0010995223491546435, 0.0005967629854874508, 0.0005967629854874508, 
        0.00028983094453144485, 0.00028983094453144485, 
        0.00012596000926328032, 0.00012596000926328032, 4.898528884253113e-05, 
        4.898528884253113e-05, 1.70468335301324e-05, 1.70468335301324e-05, 
        0.0023932532557609594, 0.0022639205787790247, 0.0022639205787790247, 
        0.001916367396540226, 0.001916367396540226, 0.0014515814760761026, 
        0.0014515814760761026, 0.0009838958277396718, 0.0009838958277396718, 
        0.0005967629854874508, 0.0005967629854874508, 0.00032389160722535494, 
        0.00032389160722535494, 0.00015730501510788895, 
        0.00015730501510788895, 6.836447775506744e-05, 6.836447775506744e-05, 
        2.6586642133385628e-05, 2.6586642133385628e-05, 9.25212596030516e-06, 
        9.25212596030516e-06, 0.0023932532557609594, 0.0022639205787790247, 
        0.0022639205787790247, 0.001916367396540226, 0.001916367396540226, 
        0.0014515814760761026, 0.0014515814760761026, 0.0009838958277396718, 
        0.0009838958277396718, 0.0005967629854874508, 0.0005967629854874508, 
        0.00032389160722535494, 0.00032389160722535494, 
        0.00015730501510788895, 0.00015730501510788895, 6.836447775506744e-05, 
        6.836447775506744e-05, 2.6586642133385628e-05, 2.6586642133385628e-05, 
        9.25212596030516e-06, 9.25212596030516e-06, 0.001162335581275325, 
        0.001099522349154643, 0.001099522349154643, 0.0009307255746682022, 
        0.0009307255746682022, 0.0007049921669183901, 0.0007049921669183901, 
        0.00047785044315610197, 0.00047785044315610197, 
        0.00028983094453144485, 0.00028983094453144485, 
        0.00015730501510788895, 0.00015730501510788895, 7.639860751586678e-05, 
        7.639860751586678e-05, 3.3202697958831117e-05, 3.3202697958831117e-05, 
        1.2912381948663445e-05, 1.2912381948663445e-05, 4.493496532478111e-06, 
        4.493496532478111e-06, 0.001162335581275325, 0.001099522349154643, 
        0.001099522349154643, 0.0009307255746682022, 0.0009307255746682022, 
        0.0007049921669183901, 0.0007049921669183901, 0.00047785044315610197, 
        0.00047785044315610197, 0.00028983094453144485, 
        0.00028983094453144485, 0.00015730501510788895, 
        0.00015730501510788895, 7.639860751586678e-05, 7.639860751586678e-05, 
        3.3202697958831117e-05, 3.3202697958831117e-05, 
        1.2912381948663445e-05, 1.2912381948663445e-05, 4.493496532478111e-06, 
        4.493496532478111e-06, 0.0005051489613062897, 0.00047785044315610213, 
        0.00047785044315610213, 0.0004044916673625216, 0.0004044916673625216, 
        0.00030638833275425546, 0.00030638833275425546, 0.0002076729465299554, 
        0.0002076729465299554, 0.00012596000926328032, 0.00012596000926328032, 
        6.836447775506744e-05, 6.836447775506744e-05, 3.3202697958831117e-05, 
        3.3202697958831117e-05, 1.4429833050509629e-05, 
        1.4429833050509629e-05, 5.61169806244827e-06, 5.61169806244827e-06, 
        1.9528655429477555e-06, 1.9528655429477555e-06, 0.0005051489613062897, 
        0.00047785044315610213, 0.00047785044315610213, 0.0004044916673625216, 
        0.0004044916673625216, 0.00030638833275425546, 0.00030638833275425546, 
        0.0002076729465299554, 0.0002076729465299554, 0.00012596000926328032, 
        0.00012596000926328032, 6.836447775506744e-05, 6.836447775506744e-05, 
        3.3202697958831117e-05, 3.3202697958831117e-05, 
        1.4429833050509629e-05, 1.4429833050509629e-05, 5.61169806244827e-06, 
        5.61169806244827e-06, 1.9528655429477555e-06, 1.9528655429477555e-06, 
        0.00019645019020577968, 0.0001858339175936924, 0.0001858339175936924, 
        0.00015730501510788898, 0.00015730501510788898, 
        0.00011915306346618386, 0.00011915306346618386, 8.076308766607072e-05, 
        8.076308766607072e-05, 4.898528884253113e-05, 4.898528884253113e-05, 
        2.6586642133385628e-05, 2.6586642133385628e-05, 
        1.2912381948663445e-05, 1.2912381948663445e-05, 5.61169806244827e-06, 
        5.61169806244827e-06, 2.182364482933049e-06, 2.182364482933049e-06, 
        7.594607467197873e-07, 7.594607467197873e-07, 0.00019645019020577968, 
        0.0001858339175936924, 0.0001858339175936924, 0.00015730501510788898, 
        0.00015730501510788898, 0.00011915306346618386, 
        0.00011915306346618386, 8.076308766607072e-05, 8.076308766607072e-05, 
        4.898528884253113e-05, 4.898528884253113e-05, 2.6586642133385628e-05, 
        2.6586642133385628e-05, 1.2912381948663445e-05, 
        1.2912381948663445e-05, 5.61169806244827e-06, 5.61169806244827e-06, 
        2.182364482933049e-06, 2.182364482933049e-06, 7.594607467197873e-07, 
        7.594607467197873e-07, 6.836447775506744e-05, 6.467002506927198e-05, 
        6.467002506927198e-05, 5.474199436935659e-05, 5.474199436935659e-05, 
        4.1465151793690705e-05, 4.1465151793690705e-05, 2.810547703921344e-05, 
        2.810547703921344e-05, 1.70468335301324e-05, 1.70468335301324e-05, 
        9.25212596030516e-06, 9.25212596030516e-06, 4.493496532478111e-06, 
        4.493496532478111e-06, 1.9528655429477555e-06, 1.9528655429477555e-06, 
        7.594607467197873e-07, 7.594607467197873e-07, 2.6429161137785596e-07, 
        2.6429161137785596e-07, 6.836447775506744e-05, 6.467002506927198e-05, 
        6.467002506927198e-05, 5.474199436935659e-05, 5.474199436935659e-05, 
        4.1465151793690705e-05, 4.1465151793690705e-05, 2.810547703921344e-05, 
        2.810547703921344e-05, 1.70468335301324e-05, 1.70468335301324e-05, 
        9.25212596030516e-06, 9.25212596030516e-06, 4.493496532478111e-06, 
        4.493496532478111e-06, 1.9528655429477555e-06, 1.9528655429477555e-06, 
        7.594607467197873e-07, 7.594607467197873e-07, 2.6429161137785596e-07, 
        2.6429161137785596e-07
    );
    
    vec3 color = vec3(0.0, 0.0, 0.0);
    for(int y=0;y<KERNEL_H;y++){
        for(int x=0;x<KERNEL_W;x++){
            float ix = float(x)*(1/tex_size.x);
            float iy = float(y)*(1/tex_size.y);
            color += max(vec3(texture(texture_sampler, pass_texture_coords+vec2(ix, iy)))-MIN_COLOR, 0.0)*kernel[y*KERNEL_W+x];
        }
    }
    color /= KERNEL_SUM;
    vec3 base_color = vec3(texture(texture_sampler, pass_texture_coords));
    out_color = vec4(color+base_color, 1.0);
}
